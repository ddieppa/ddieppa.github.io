---
---

<!-- Search Modal -->
<div 
  id="search-modal" 
  class="fixed inset-0 z-50 hidden"
  role="dialog"
  aria-modal="true"
  aria-label="Search"
>
  <!-- Backdrop -->
  <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" id="search-backdrop"></div>
  
  <!-- Modal Content -->
  <div class="relative max-w-2xl mx-auto mt-20 mx-4">
    <div class="rounded-xl shadow-2xl overflow-hidden" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
      <!-- Search Input -->
      <div class="flex items-center gap-3 px-4 border-b" style="border-color: var(--border-color);">
        <svg class="w-5 h-5 flex-shrink-0" style="color: var(--text-tertiary);" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        <input 
          type="text" 
          id="search-input"
          class="flex-1 py-4 bg-transparent outline-none text-lg"
          style="color: var(--text-primary);"
          placeholder="Search posts..."
          autocomplete="off"
        />
        <kbd class="px-2 py-1 rounded text-xs font-mono" style="background-color: var(--bg-tertiary); color: var(--text-tertiary);">ESC</kbd>
      </div>
      
      <!-- Search Results -->
      <div id="search-results" class="max-h-96 overflow-y-auto">
        <div class="p-4 text-center" style="color: var(--text-tertiary);">
          Type to search posts...
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  import Fuse from 'fuse.js';
  
  interface Post {
    title: string;
    description: string;
    slug: string;
    tags: string[];
    pubDate: string;
  }
  
  let fuse: Fuse<Post> | null = null;
  let posts: Post[] = [];
  
  async function loadPosts() {
    if (posts.length > 0) return;
    
    try {
      const response = await fetch('/api/search.json');
      posts = await response.json();
      
      fuse = new Fuse(posts, {
        keys: ['title', 'description', 'tags'],
        threshold: 0.3,
        includeScore: true
      });
    } catch (error) {
      console.error('Failed to load search index:', error);
    }
  }
  
  function openSearch() {
    const modal = document.getElementById('search-modal');
    const input = document.getElementById('search-input') as HTMLInputElement;
    
    modal?.classList.remove('hidden');
    input?.focus();
    document.body.style.overflow = 'hidden';
    
    loadPosts();
  }
  
  function closeSearch() {
    const modal = document.getElementById('search-modal');
    const input = document.getElementById('search-input') as HTMLInputElement;
    
    modal?.classList.add('hidden');
    document.body.style.overflow = '';
    
    if (input) {
      input.value = '';
      renderResults([]);
    }
  }
  
  function renderResults(results: Post[]) {
    const container = document.getElementById('search-results');
    if (!container) return;
    
    if (results.length === 0) {
      container.innerHTML = `
        <div class="p-4 text-center" style="color: var(--text-tertiary);">
          No results found
        </div>
      `;
      return;
    }
    
    container.innerHTML = results.map(post => `
      <a 
        href="/blog/${post.slug}" 
        class="block px-4 py-3 transition-colors hover:bg-[var(--bg-secondary)]"
      >
        <h3 class="font-semibold mb-1" style="color: var(--text-primary);">${post.title}</h3>
        <p class="text-sm line-clamp-1" style="color: var(--text-secondary);">${post.description}</p>
      </a>
    `).join('');
  }
  
  function handleSearch(query: string) {
    if (!fuse || !query.trim()) {
      renderResults([]);
      return;
    }
    
    const results = fuse.search(query).slice(0, 10).map(r => r.item);
    renderResults(results);
  }
  
  function setupSearch() {
    const trigger = document.getElementById('search-trigger');
    const backdrop = document.getElementById('search-backdrop');
    const input = document.getElementById('search-input');
    
    trigger?.addEventListener('click', openSearch);
    backdrop?.addEventListener('click', closeSearch);
    
    input?.addEventListener('input', (e) => {
      handleSearch((e.target as HTMLInputElement).value);
    });
    
    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        openSearch();
      }
      
      if (e.key === 'Escape') {
        closeSearch();
      }
    });
  }
  
  document.addEventListener('astro:page-load', setupSearch);
  setupSearch();
</script>

